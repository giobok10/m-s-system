{% extends "layouts/base.html" %}

{% block title %}Tomar Orden{% endblock %}

{% block content %}
<div class="row">
    <!-- Menu Column -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-utensils"></i> Menú</h5>
            </div>
            <div class="card-body">
                {% for category in ['Principal', 'Bebida', 'Combo'] %}
                <h6 class="text-primary mt-3">{{ category }}</h6>
                <div class="row mb-4">
                    {% for product in products if product.category == category %}
                    <div class="col-md-6 mb-2">
                        <div class="card product-card h-100" 
                             data-product='{{ product.to_dict()|tojson|safe }}' 
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ product.name }}</h6>
                                        {% if product.category == 'Principal' %}
                                            <small class="text-{{ 'success' if product.stock > 5 else 'warning' if product.stock > 0 else 'danger' }}" data-stock-id="{{ product.id }}">
                                                Stock Base: {{ product.stock }}
                                            </small>
                                        {% elif product.category == 'Combo' %}
                                            <small class="text-muted">Q{{ "%.2f"|format(product.price) }}</small>
                                        {% else %}
                                            <p class="mb-0 text-muted">Q{{ "%.2f"|format(product.price) }}</p>
                                            <small class="text-{{ 'success' if product.stock > 5 else 'warning' if product.stock > 0 else 'danger' }}" data-stock-id="{{ product.id }}">
                                                Stock: {{ product.stock }}
                                            </small>
                                        {% endif %}
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm add-product-btn" {{ 'disabled' if product.stock == 0 and product.category != 'Combo' else '' }}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Order Column -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-shopping-cart"></i> Orden Actual</h5>
            </div>
            <div class="card-body">
                <form id="orderForm" method="POST" action="{{ url_for('waiter.create_order') }}">
                    <div class="mb-3">
                        <label for="customer_name" class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name">
                    </div>
                    <div class="mb-3">
                        <label for="customer_phone" class="form-label">Teléfono (Opcional)</label>
                        <input type="text" class="form-control" id="customer_phone" name="customer_phone">
                    </div>
                    <div id="orderItems" style="min-height: 100px;">
                        <p class="text-muted text-center">No hay productos seleccionados</p>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <strong>Total: Q<span id="orderTotal">0.00</span></strong>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" id="createOrderBtn" disabled>
                            <i class="fas fa-check"></i> Crear Orden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="variantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="variantModalTitle">Seleccionar Variante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="variantModalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="quantityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quantityModalTitle">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="quantity" class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="quantity" min="1" value="1">
                    <small class="text-muted">Stock disponible: <span id="availableStock"></span></small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Extras</label>
                    <div id="extrasContainer">
                        {% for extra in extras %}
                        <div class="extra-item d-flex justify-content-between align-items-center mb-2">
                            <label for="extra-{{ extra.id }}" class="form-label">
                                {{ extra.name }} (+Q{{ "%.2f"|format(extra.price) }})
                                <small class="text-muted ms-2" data-stock-id="extra-{{ extra.id }}"></small>
                            </label>
                            <input type="number" class="form-control extra-quantity-input"
                                   id="extra-{{ extra.id }}"
                                   data-extra-id="{{ extra.id }}"
                                   data-extra-name="{{ extra.name }}"
                                   data-extra-price="{{ extra.price }}"
                                   data-extra-stock="{{ extra.stock }}"
                                   value="0" min="0" style="width: 80px;">
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Notas Especiales</label>
                    <textarea class="form-control" id="notes" rows="2" placeholder="Ej: sin cebolla"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="addToOrderBtn">Agregar a Orden</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let orderItems = [];
let currentProductData = null;
let currentVariant = null;

const quantityModalEl = document.getElementById('quantityModal');
const quantityModal = new bootstrap.Modal(quantityModalEl);
const variantModal = new bootstrap.Modal(document.getElementById('variantModal'));

document.addEventListener('DOMContentLoaded', function() {
    // Accessibility fix for modal focus
    let modalTriggerElement = null;
    quantityModalEl.addEventListener('show.bs.modal', function (event) {
        if (event.relatedTarget) {
            modalTriggerElement = event.relatedTarget;
        }
    });
    quantityModalEl.addEventListener('hidden.bs.modal', function () {
        if (modalTriggerElement) {
            modalTriggerElement.focus();
        }
    });

    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function() {
            const product = JSON.parse(this.dataset.product);
            if (product.category === 'Principal') {
                openVariantModal(product);
            } else {
                openQuantityModal(product);
            }
        });
    });
    
    document.getElementById('addToOrderBtn').addEventListener('click', addToOrder);
    document.getElementById('orderForm').addEventListener('submit', submitOrder);
});

function openVariantModal(product) {
    currentProductData = product;
    const variants = product.variants;
    
    document.getElementById('variantModalTitle').textContent = `Seleccionar variante para ${product.name}`;
    const body = document.getElementById('variantModalBody');
    body.innerHTML = '';

    if (!variants || variants.length === 0) {
        body.innerHTML = '<p class="text-muted">Este producto no tiene variantes definidas y no se puede vender directamente.</p>';
    } else {
        variants.forEach(variant => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-primary w-100 mb-2';
            btn.textContent = `${variant.name} - Q${variant.price.toFixed(2)}`;
            btn.onclick = () => {
                currentVariant = variant;
                variantModal.hide();
                openQuantityModal(product, variant);
            };
            body.appendChild(btn);
        });
    }
    variantModal.show();
}

function openQuantityModal(product, variant = null) {
    currentProductData = product;
    currentVariant = variant;

    const itemBeingAdded = variant || product;
    document.getElementById('quantityModalTitle').textContent = 'Agregar ' + itemBeingAdded.name;
    
    // Reset modal state
    document.getElementById('quantity').value = 1;
    document.getElementById('notes').value = '';
    document.querySelectorAll('.extra-quantity-input').forEach(input => input.value = 0);

    updateStockInfo();
    quantityModal.show();
}

function updateStockInfo() {
    const itemBeingAdded = currentVariant || currentProductData;
    const isCombo = currentProductData.category === 'Combo';

    if (isCombo) {
        document.getElementById('availableStock').textContent = 'N/A (se valida al crear)';
        document.getElementById('quantity').removeAttribute('max');
        document.getElementById('addToOrderBtn').disabled = false;
    } else {
        const stockToCheck = currentVariant ? currentProductData.stock : itemBeingAdded.stock;
        const consumptionRate = currentVariant ? currentVariant.stock_consumption : 1;
        const baseProductId = currentVariant ? currentProductData.id : null;
        const quantityInCart = getQuantityInCart(itemBeingAdded.id, baseProductId);
        const availableStockUnits = Math.floor((stockToCheck - quantityInCart) / consumptionRate);
        
        document.getElementById('availableStock').textContent = availableStockUnits;
        const quantityInput = document.getElementById('quantity');
        quantityInput.max = availableStockUnits > 0 ? availableStockUnits : 0;
        quantityInput.disabled = availableStockUnits <= 0;
        document.getElementById('addToOrderBtn').disabled = availableStockUnits <= 0;
    }

    // Update extras stock
    document.querySelectorAll('.extra-quantity-input').forEach(input => {
        const extraId = input.dataset.extraId;
        const extraStock = parseInt(input.dataset.extraStock);
        const extraQuantityInCart = getExtraQuantityInCart(extraId);
        const availableExtraStock = extraStock - extraQuantityInCart;
        const stockLabel = input.previousElementSibling.querySelector('small');
        
        input.max = availableExtraStock;
        if (availableExtraStock <= 0) {
            stockLabel.textContent = ' (Agotado)';
            input.disabled = true;
        } else {
            stockLabel.textContent = ` (Stock: ${availableExtraStock})`;
            input.disabled = false;
        }
    });
}

function addToOrder() {
    const quantity = parseInt(document.getElementById('quantity').value);
    if (isNaN(quantity) || quantity <= 0) return;

    const itemBeingAdded = currentVariant || currentProductData;
    const notes = document.getElementById('notes').value;
    let itemPrice = itemBeingAdded.price;
    const selectedExtras = [];
    const extraNames = [];

    document.querySelectorAll('.extra-quantity-input').forEach(input => {
        const extraQuantity = parseInt(input.value);
        if (extraQuantity > 0) {
            const extraPrice = parseFloat(input.dataset.extraPrice);
            itemPrice += extraPrice * extraQuantity;
            selectedExtras.push({ id: input.dataset.extraId, name: input.dataset.extraName, price: extraPrice, quantity: extraQuantity });
            extraNames.push(`${input.dataset.extraName} (x${extraQuantity})`);
        }
    });

    const item = {
        product_id: itemBeingAdded.id,
        display_name: currentVariant ? `${currentProductData.name} (${currentVariant.name})` : itemBeingAdded.name,
        price: itemPrice,
        quantity: quantity,
        extras: selectedExtras,
        notes: notes,
        total: itemPrice * quantity,
        base_product_id: currentVariant ? currentProductData.id : null,
        stock_consumption: currentVariant ? currentVariant.stock_consumption : 1,
        displayExtras: extraNames.join(', '),
        components: currentProductData.category === 'Combo' ? currentProductData.components : []
    };

    orderItems.push(item);
    updateOrderDisplay();
    quantityModal.hide();
}

function getQuantityInCart(productId, baseProductId = null) {
    let totalConsumption = 0;
    orderItems.forEach(item => {
        // Case 1: Direct match (item is a variant of the base product being checked)
        if (baseProductId && item.base_product_id === baseProductId) {
            totalConsumption += item.quantity * item.stock_consumption;
        }

        // Case 2: Direct match (item is a simple product being checked)
        if (productId && !baseProductId && String(item.product_id) === String(productId)) {
            totalConsumption += item.quantity;
        }

        // Case 3: Indirect match (item is a combo that contains the product being checked)
        if (item.components && item.components.length > 0) {
            item.components.forEach(component => {
                // Check if the component's product ID matches the base product ID we are looking for
                if (baseProductId && String(component.component_product_id) === String(baseProductId)) {
                    totalConsumption += component.quantity * item.quantity;
                }
                // Check if the component's product ID matches the simple product ID we are looking for
                if (productId && !baseProductId && String(component.component_product_id) === String(productId)) {
                    totalConsumption += component.quantity * item.quantity;
                }
            });
        }
    });
    return totalConsumption;
}

function getExtraQuantityInCart(extraId) {
    let total = 0;
    orderItems.forEach(item => {
        item.extras.forEach(extra => {
            if (String(extra.id) === String(extraId)) {
                total += extra.quantity * item.quantity;
            }
        });
    });
    return total;
}

function updateOrderDisplay() {
    const container = document.getElementById('orderItems');
    const totalElement = document.getElementById('orderTotal');
    const createBtn = document.getElementById('createOrderBtn');

    if (orderItems.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay productos seleccionados</p>';
        totalElement.textContent = '0.00';
        createBtn.disabled = true;
    } else {
        let html = '';
        let total = 0;
        orderItems.forEach((item, index) => {
            html += `
                <div class="d-flex justify-content-between align-items-start mb-2 p-2 border rounded">
                    <div>
                        <strong>${item.display_name}</strong><br>
                        <small class="text-muted">Cant: ${item.quantity} | Q${item.price.toFixed(2)} c/u</small>
                        ${item.displayExtras ? `<br><small class="text-muted">Extras: ${item.displayExtras}</small>` : ''}
                        ${item.notes ? `<br><small class="text-info">Notas: ${item.notes}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <strong>Q${item.total.toFixed(2)}</strong><br>
                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            total += item.total;
        });
        container.innerHTML = html;
        totalElement.textContent = total.toFixed(2);
        createBtn.disabled = false;
    }
    updateAllCardStocks();
}

function removeItem(index) {
    orderItems.splice(index, 1);
    updateOrderDisplay();
}

function updateAllCardStocks() {
    document.querySelectorAll('.product-card').forEach(card => {
        const product = JSON.parse(card.dataset.product);
        const stockElement = card.querySelector(`[data-stock-id='${product.id}']`);
        const addButton = card.querySelector('.add-product-btn');

        if (!stockElement) return; // Skip combos or items without stock display

        let stockInCart = 0;
        if (product.category === 'Principal') {
            // For base products, sum consumption of all its variants in the cart
            stockInCart = getQuantityInCart(null, product.id);
        } else {
            // For simple products (Bebida)
            stockInCart = getQuantityInCart(product.id);
        }

        const remainingStock = product.stock - stockInCart;
        
        if (product.category === 'Principal') {
            stockElement.textContent = `Stock Base: ${remainingStock}`;
        } else {
            stockElement.textContent = `Stock: ${remainingStock}`;
        }

        // Update color based on remaining stock
        stockElement.classList.remove('text-success', 'text-warning', 'text-danger');
        if (remainingStock > 5) {
            stockElement.classList.add('text-success');
        } else if (remainingStock > 0) {
            stockElement.classList.add('text-warning');
        } else {
            stockElement.classList.add('text-danger');
        }

        // Disable button if no stock left
        if (addButton) {
            addButton.disabled = remainingStock <= 0;
        }
    });
}

function submitOrder(e) {
    if (orderItems.length === 0) {
        e.preventDefault();
        alert("No se puede crear una orden vacía.");
        return;
    }
    const form = e.target;
    form.querySelectorAll('input[name="items"]').forEach(inp => inp.remove());
    orderItems.forEach(item => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'items';
        const submitItem = { 
            product_id: item.product_id, 
            quantity: item.quantity, 
            extras: item.extras, 
            notes: item.notes 
        };
        input.value = JSON.stringify(submitItem);
        form.appendChild(input);
    });
}
</script>
{% endblock %}