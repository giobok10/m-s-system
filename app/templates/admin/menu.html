{% extends "layouts/base.html" %}

{% block title %}Gestión de Menú{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-utensils"></i> Gestión de Menú</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus"></i> Agregar Producto
    </button>
</div>

<div class="row">
    {% for category in ['Principal', 'Bebida', 'Extra', 'Combo'] %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>{{ category }}</h5>
            </div>
            <div class="card-body">
                {% set products_in_category = products|selectattr('category', 'equalto', category)|list %}
                {% if not products_in_category %}
                    <p class="text-muted">No hay productos en esta categoría.</p>
                {% else %}
                    {% for product in products_in_category %}
                    <div class="border rounded mb-3 p-2">
                        <!-- Product Info -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ product.name }}</strong><br>
                                {% if product.category == 'Principal' %}
                                    <small class="text-muted">Stock Base: {{ product.stock }}</small>
                                {% elif product.category == 'Combo' %}
                                    <small class="text-muted">Q{{ "%.2f"|format(product.price) }}</small>
                                {% else %}
                                    <small class="text-muted">Q{{ "%.2f"|format(product.price) }} | Stock: {{ product.stock }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-product-btn" data-product='{{ product.to_dict()|tojson|safe }}'>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('admin.delete_product', product_id=product.id) }}" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar este producto?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Variants or Components Section -->
                        {% if product.category == 'Principal' or product.category == 'Combo' %}
                        <div class="mt-2 ps-3">
                            {% if product.category == 'Principal' %}
                                <h6 class="text-muted small">Variantes:</h6>
                                {% for variant in product.variants %}
                                {% if variant.is_active %}
                                <div class="d-flex justify-content-between align-items-center mb-1 p-1 bg-light rounded">
                                    <div>
                                        <span>{{ variant.name }}</span><br>
                                        <small class="text-muted">Q{{ "%.2f"|format(variant.price) }} | Consume: {{ variant.stock_consumption }}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary edit-variant-btn" data-variant='{{ variant.to_dict()|tojson|safe }}'>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('admin.delete_variant', variant_id=variant.id) }}" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar esta variante?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <button class="btn btn-sm btn-success mt-2" onclick="openAddVariantModal({{ product.id }})">
                                    <i class="fas fa-plus"></i> Agregar Variante
                                </button>
                            {% elif product.category == 'Combo' %}
                                <h6 class="text-muted small">Componentes:</h6>
                                {% for item in product.components %}
                                    <div class="d-flex justify-content-between align-items-center mb-1 p-1 bg-light rounded">
                                        <span>{{ item.component.name }} (x{{ item.quantity }})</span>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.add_product') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoría</label>
                        <select class="form-control" id="category" name="category" required onchange="toggleFields('add')">
                            <option value="">Seleccionar...</option>
                            <option value="Principal">Principal (Producto Base con Stock)</option>
                            <option value="Bebida">Bebida</option>
                            <option value="Extra">Extra</option>
                            <option value="Combo">Combo (Paquete de productos)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3" id="add-price-group">
                        <label for="price" class="form-label">Precio</label>
                        <input type="number" step="0.01" class="form-control" id="price" name="price">
                    </div>
                    <div class="mb-3" id="add-stock-group">
                        <label for="stock" class="form-label">Stock Inicial</label>
                        <input type="number" class="form-control" id="stock" name="stock" value="0">
                    </div>
                    <div class="mb-3 d-none" id="add-combo-group">
                        <h5>Componentes del Combo</h5>
                        <div id="add-combo-list"></div>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="addComboComponent('add')">Agregar Componente</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editProductForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_category_hidden" name="category">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3" id="edit-price-group">
                        <label for="edit_price" class="form-label">Precio</label>
                        <input type="number" step="0.01" class="form-control" id="edit_price" name="price">
                    </div>
                    <div class="mb-3" id="edit-stock-group">
                        <label for="edit_stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="edit_stock" name="stock">
                    </div>
                    <div class="mb-3 d-none" id="edit-combo-group">
                        <h5>Componentes del Combo</h5>
                        <div id="edit-combo-list"></div>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="addComboComponent('edit')">Agregar Componente</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Variante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="addVariantForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="variant_name" class="form-label">Nombre de la Variante</label>
                        <input type="text" class="form-control" id="variant_name" name="variant_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="variant_price" class="form-label">Precio</label>
                        <input type="number" step="0.01" class="form-control" id="variant_price" name="variant_price" required>
                    </div>
                    <div class="mb-3">
                        <label for="variant_consumption" class="form-label">Consumo de Stock</label>
                        <input type="number" class="form-control" id="variant_consumption" name="variant_consumption" value="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Variante</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Variant Modal -->
<div class="modal fade" id="editVariantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Variante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editVariantForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_variant_name" class="form-label">Nombre de la Variante</label>
                        <input type="text" class="form-control" id="edit_variant_name" name="variant_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_variant_price" class="form-label">Precio</label>
                        <input type="number" step="0.01" class="form-control" id="edit_variant_price" name="variant_price" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_variant_consumption" class="form-label">Consumo de Stock</label>
                        <input type="number" class="form-control" id="edit_variant_consumption" name="variant_consumption" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar Variante</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden template for combo component row -->
<div id="combo-component-template" class="d-none">
    <div class="row align-items-center mb-2 component-row">
        <div class="col-7">
            <select class="form-control component-id" name="component_ids[]">
                <option value="">Seleccionar producto...</option>
                {% for comp_product in component_products %}
                    <option value="{{ comp_product.id }}">{{ comp_product.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
            <input type="number" class="form-control component-quantity" name="component_quantities[]" value="1" min="1">
        </div>
        <div class="col-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.component-row').remove()"><i class="fas fa-trash"></i></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Make component_products available to JS
const COMPONENT_PRODUCTS = {{ component_products|tojson|safe }};

function toggleFields(formType) {
    const category = document.getElementById(formType === 'add' ? 'category' : 'edit_category').value;
    const priceGroup = document.getElementById(formType + '-price-group');
    const stockGroup = document.getElementById(formType + '-stock-group');
    const comboGroup = document.getElementById(formType + '-combo-group');

    priceGroup.style.display = 'none';
    stockGroup.style.display = 'none';
    comboGroup.classList.add('d-none');

    if (category === 'Principal') {
        stockGroup.style.display = 'block';
    } else if (category === 'Bebida' || category === 'Extra') {
        priceGroup.style.display = 'block';
        stockGroup.style.display = 'block';
    } else if (category === 'Combo') {
        priceGroup.style.display = 'block';
        comboGroup.classList.remove('d-none');
    }
}

function addComboComponent(formType) {
    const list = document.getElementById(formType + '-combo-list');
    const template = document.getElementById('combo-component-template').firstElementChild.cloneNode(true);
    list.appendChild(template);
}

function editProduct(product) {
    const form = document.getElementById('editProductForm');
    form.action = '/admin/edit_product/' + product.id;

    document.getElementById('edit_name').value = product.name;
    document.getElementById('edit_category_hidden').value = product.category;

    const priceGroup = document.getElementById('edit-price-group');
    const stockGroup = document.getElementById('edit-stock-group');
    const comboGroup = document.getElementById('edit-combo-group');
    const comboList = document.getElementById('edit-combo-list');

    priceGroup.style.display = 'none';
    stockGroup.style.display = 'none';
    comboGroup.classList.add('d-none');
    comboList.innerHTML = '';

    if (product.category === 'Principal') {
        stockGroup.style.display = 'block';
        document.getElementById('edit_stock').value = product.stock;
    } else if (product.category === 'Bebida' || product.category === 'Extra') {
        priceGroup.style.display = 'block';
        stockGroup.style.display = 'block';
        document.getElementById('edit_price').value = product.price;
        document.getElementById('edit_stock').value = product.stock;
    } else if (product.category === 'Combo') {
        priceGroup.style.display = 'block';
        comboGroup.classList.remove('d-none');
        document.getElementById('edit_price').value = product.price;

        if (product.components && product.components.length > 0) {
            product.components.forEach(item => {
                const template = document.getElementById('combo-component-template').firstElementChild.cloneNode(true);
                template.querySelector('.component-id').value = item.component_product_id;
                template.querySelector('.component-quantity').value = item.quantity;
                comboList.appendChild(template);
            });
        }
    }

    var modal = new bootstrap.Modal(document.getElementById('editProductModal'));
    modal.show();
}

function openAddVariantModal(parentId) {
    const form = document.getElementById('addVariantForm');
    if (form) {
        form.action = '/admin/add_variant/' + parentId;
        var modal = new bootstrap.Modal(document.getElementById('addVariantModal'));
        modal.show();
    }
}

function openEditVariantModal(variant) {
    const form = document.getElementById('editVariantForm');
    if(form) {
        form.action = '/admin/edit_variant/' + variant.id;
        document.getElementById('edit_variant_name').value = variant.name;
        document.getElementById('edit_variant_price').value = variant.price;
        document.getElementById('edit_variant_consumption').value = variant.stock_consumption;
        var modal = new bootstrap.Modal(document.getElementById('editVariantModal'));
        modal.show();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    toggleFields('add');

    document.querySelectorAll('.edit-product-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productData = JSON.parse(this.dataset.product);
            editProduct(productData);
        });
    });

    document.querySelectorAll('.edit-variant-btn').forEach(button => {
        button.addEventListener('click', function() {
            const variantData = JSON.parse(this.dataset.variant);
            openEditVariantModal(variantData);
        });
    });
});
</script>
{% endblock %}
